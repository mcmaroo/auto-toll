<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTO TOLL | ŸÜÿ∏ÿßŸÖ ÿ®Ÿàÿßÿ®ÿßÿ™ ÿ∞ŸÉŸä</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #020617; color: #f8fafc; }
        .glass-card { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .modal-overlay { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); }
        .animate-slide-down { animation: slideDown 0.5s ease-out; }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://eakwicttewontgjkcuci.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3drTyNWZGsuhE3F6-Qi0qw_4WTO9RkK';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const USER_CREDENTIALS = {
            marwan: { password: 'Marwan@123', plate: 'ÿ£ ÿ® ÿ™ 3900', name: 'Marwan Ahmed', role: 'driver' },
            ahmed: { password: 'Ahmed@123', plate: 'ÿ¨ ÿØ ŸáŸÄ 7744', name: 'Ahmed Ali', role: 'driver' }, 
            admin: { password: 'Admin@123', plate: null, name: 'ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿπÿßŸÖ', role: 'admin' }
        };

        function App() {
            const [user, setUser] = useState(null);
            const [logs, setLogs] = useState([]);
            const [notification, setNotification] = useState(null);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [showInstapay, setShowInstapay] = useState(false);
            const [rechargeCode, setRechargeCode] = useState('');

            useEffect(() => {
                if (!user) return;
                fetchLogs();

                const channel = supabaseClient.channel('realtime_changes')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'toll_logs' }, (payload) => {
                        const newLog = payload.new;
                        const isOwner = newLog.car_plate === user.plate || newLog.car_name === user.name;
                        
                        if (user.role === 'admin' || isOwner) {
                            setLogs(prev => [newLog, ...prev]);
                            // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ (ÿßŸÑÿ™ŸÜÿ®ŸäŸá ÿßŸÑŸÑŸä ÿ∑ŸÑÿ®ÿ™Ÿá)
                            if(newLog.charge > 0) {
                                setNotification(newLog);
                                setTimeout(() => setNotification(null), 5000);
                            }
                        }
                    })
                    .subscribe();

                return () => supabaseClient.removeChannel(channel);
            }, [user]);

            const fetchLogs = async () => {
                let query = supabaseClient.from('toll_logs').select('*').order('created_at', { ascending: false }).limit(20);
                if (user.role !== 'admin') {
                    query = query.or(`car_plate.eq."${user.plate}",car_name.eq."${user.name}"`);
                }
                const { data } = await query;
                setLogs(data || []);
            };

            const handleInstapay = async (e) => {
                e.preventDefault();
                if (rechargeCode === '123456789') {
                    // ŸÜÿ¨ŸÑÿ® ÿ£ÿ≠ÿØÿ´ ÿ≥ÿ¨ŸÑ ÿπÿ¥ÿßŸÜ ŸÜÿπÿ±ŸÅ ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≠ŸÇŸäŸÇŸä ŸÇÿ®ŸÑ ÿßŸÑÿ¥ÿ≠ŸÜ
                    const { data: latestData } = await supabaseClient.from('toll_logs').select('new_balance').eq('car_name', user.name).order('created_at', { ascending: false }).limit(1);
                    
                    const currentBal = latestData && latestData[0] ? latestData[0].new_balance : 0;
                    
                    const { error } = await supabaseClient.from('toll_logs').insert([{
                        car_name: user.name,
                        car_plate: user.plate || 'N/A',
                        old_balance: currentBal,
                        new_balance: currentBal + 100,
                        charge: 0,
                        reason: 'ÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØ Instapay',
                        dynamic_fine: 5,
                        emergency_active: false
                    }]);
                    
                    if (!error) { 
                        alert("ÿ™ŸÖ ÿ¥ÿ≠ŸÜ 100 ÿ¨ŸÜŸäŸá ÿ®ŸÜÿ¨ÿßÿ≠!"); 
                        setShowInstapay(false); 
                        setRechargeCode('');
                        fetchLogs(); 
                    }
                } else { alert("ŸÉŸàÿØ ÿÆÿßÿ∑ÿ¶!"); }
            };

            if (!user) return (
                <div className="flex items-center justify-center min-h-screen p-6">
                    <div className="glass-card p-10 rounded-3xl w-full max-w-md shadow-2xl text-center">
                        <h1 className="text-3xl font-bold mb-8 text-blue-500 italic">AUTO TOLL</h1>
                        <form onSubmit={(e) => { e.preventDefault(); const u = USER_CREDENTIALS[username.toLowerCase()]; if (u && u.password === password) setUser(u); else alert("ÿÆÿ∑ÿ£!"); }} className="space-y-4">
                            <input type="text" placeholder="Username" className="w-full p-4 bg-slate-950 rounded-2xl border border-slate-800 outline-none focus:border-blue-500 text-center" value={username} onChange={e => setUsername(e.target.value)} />
                            <input type="password" placeholder="Password" className="w-full p-4 bg-slate-950 rounded-2xl border border-slate-800 outline-none focus:border-blue-500 text-center" value={password} onChange={e => setPassword(e.target.value)} />
                            <button className="w-full bg-blue-600 p-4 rounded-2xl font-bold hover:bg-blue-700 transition-all">Login</button>
                        </form>
                    </div>
                </div>
            );

            const latestLog = logs[0] || {};
            const balance = latestLog.new_balance || 0;

            return (
                <div className="min-h-screen pb-12 px-4 md:px-10 max-w-6xl mx-auto pt-20 relative">
                    
                    {/* ÿßŸÑÿ™ŸÜÿ®ŸäŸá ÿßŸÑÿπŸÑŸàŸä ÿßŸÑŸÑŸä ŸÉÿßŸÜ ŸÜÿßŸÇÿµ */}
                    {notification && (
                        <div className="fixed top-5 left-1/2 -translate-x-1/2 z-[100] w-full max-w-md px-4 animate-slide-down">
                            <div className="bg-blue-600 text-white p-4 rounded-2xl shadow-2xl border border-blue-400 flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <span className="text-2xl">üöó</span>
                                    <div>
                                        <p className="font-bold text-sm">ÿ™ŸÖ ÿπÿ®Ÿàÿ± ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿ±ÿ≥ŸàŸÖ</p>
                                        <p className="text-xs opacity-80">{notification.car_name} - ÿØŸÅÿπ {notification.charge} ÿ¨.ŸÖ</p>
                                    </div>
                                </div>
                                <div className="text-xs font-bold bg-white/20 px-2 py-1 rounded">LIVE</div>
                            </div>
                        </div>
                    )}

                    <button onClick={() => setShowInstapay(true)} className="fixed top-6 left-6 bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-2xl font-bold shadow-xl z-50 transition-all">üí≥ Instapay</button>
                    
                    {showInstapay && (
                        <div className="fixed inset-0 modal-overlay z-[60] flex items-center justify-center p-6">
                            <div className="glass-card p-8 rounded-3xl w-full max-w-sm">
                                <h3 className="text-xl font-bold mb-4 text-center">Recharge Account</h3>
                                <form onSubmit={handleInstapay} className="space-y-4">
                                    <input type="text" placeholder="Enter Code (123456789)" className="w-full p-4 bg-slate-900 rounded-xl border border-slate-700 text-center outline-none focus:border-purple-500 text-white font-bold" value={rechargeCode} onChange={e => setRechargeCode(e.target.value)} />
                                    <div className="flex gap-2">
                                        <button type="submit" className="flex-1 bg-purple-600 p-3 rounded-xl font-bold">Charge</button>
                                        <button type="button" onClick={() => setShowInstapay(false)} className="flex-1 bg-slate-800 p-3 rounded-xl font-bold">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {balance < 50 && user.role !== 'admin' && (
                        <div className="bg-red-600/20 border border-red-600 text-red-400 p-4 rounded-2xl mb-6 text-center animate-pulse font-bold">
                            ‚ö†Ô∏è Warning: Balance is {balance} EGP. Penalty of 500 EGP applied at -100!
                        </div>
                    )}

                    <header className="flex justify-between items-center mb-10">
                        <div>
                            <h1 className="text-3xl font-black text-blue-500 italic">AUTO TOLL</h1>
                            <p className="text-slate-400 font-bold uppercase tracking-widest">{user.name}</p>
                        </div>
                        <button onClick={() => setUser(null)} className="bg-red-500/10 text-red-500 px-6 py-2 rounded-xl border border-red-500/20 font-bold">Logout</button>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                        <div className="glass-card p-8 rounded-[2rem] text-center border-b-4 border-green-500/30">
                            <p className="text-slate-500 text-xs mb-1 font-bold">BALANCE</p>
                            <h2 className={`text-4xl font-black ${balance < 0 ? 'text-red-500 animate-pulse' : 'text-green-400'}`}>{balance} <span className="text-sm">EGP</span></h2>
                        </div>
                        <div className="glass-card p-8 rounded-[2rem] text-center">
                            <p className="text-slate-500 text-xs mb-1 font-bold">EMERGENCY LANE</p>
                            <h2 className={`text-xl font-black ${latestLog.emergency_active ? 'text-green-500' : 'text-red-500'}`}>{latestLog.emergency_active ? '‚óè OPEN' : '‚óè CLOSED'}</h2>
                        </div>
                        <div className="glass-card p-8 rounded-[2rem] text-center border-b-4 border-blue-500/30">
                            <p className="text-slate-500 text-xs mb-1 font-bold">CURRENT TOLL</p>
                            <h2 className="text-3xl font-black text-blue-400">{latestLog.dynamic_fine || 5} <span className="text-sm font-normal">EGP</span></h2>
                        </div>
                        <div className="glass-card p-8 rounded-[2rem] text-center">
                            <p className="text-slate-500 text-xs mb-1 font-bold">LOGS</p>
                            <h2 className="text-3xl font-black">{logs.length}</h2>
                        </div>
                    </div>

                    <div className="glass-card rounded-[2rem] overflow-hidden shadow-2xl">
                        <table className="w-full text-right">
                            <thead className="bg-slate-950 text-slate-500 text-[10px] uppercase font-bold">
                                <tr>
                                    <th className="p-5">Time</th>
                                    <th className="p-5">Plate</th>
                                    <th className="p-5">Charge</th>
                                    <th className="p-5">Status</th>
                                    <th className="p-5 text-center">Balance</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800">
                                {logs.map((log, i) => (
                                    <tr key={i} className="hover:bg-blue-600/5 transition-all">
                                        <td className="p-5 text-xs text-slate-400 font-mono italic">{new Date(log.created_at).toLocaleTimeString('ar-EG')}</td>
                                        <td className="p-5 font-black text-yellow-500">{log.car_plate}</td>
                                        <td className={`p-5 font-bold ${log.charge > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                            {log.charge > 0 ? `-${log.charge}` : `+${log.new_balance - log.old_balance}`}
                                        </td>
                                        <td className="p-5 text-[10px] text-slate-400 font-bold">
                                            <span className={`px-2 py-1 rounded-md ${log.charge === 0 ? 'bg-green-500/10 text-green-500' : 'bg-slate-800'}`}>
                                                {log.reason}
                                            </span>
                                        </td>
                                        <td className="p-5 text-center font-black">{log.new_balance}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
